# BUBBLES SYSTEM — генерация пузырей и распределение наград

Этот документ описывает полную логику появления пузырей (soap bubbles), их поведение и распределение наград. Документ является частью канонической спецификации проекта **Cosmix**.

---

## 1. Термины и обозначения

- **Bubble** — мыльный пузырь, который поднимается вверх внутри стакана.
- **Reward** — награда внутри пузыря (монеты, очки, бонус).
- `Level` — текущий уровень сессии (УТК).
- `Multiply` — текущий игровой множитель (Cosmometer).
- `PointCoef` — коэффициент прокачки очков.
- `MoneyCoef` — коэффициент прокачки монет.
- `base = 10` — базовая величина очков.
- `Random01()` — случайное число в диапазоне [0..1).
- `RandomRange(a,b)` — случайное число в диапазоне [a..b].
- `RandomInt(1..5)` — случайное целое в диапазоне [1..5].

---

## 2. Когда появляется пузырь (Spawn Triggers)

Пузырь может появляться в двух ситуациях:

### 2.1 После сокращения цепочки (основной триггер)
После каждого **collapse** (сокращения цепочки) выполняется проверка появления пузыря.

Обозначим:
- `P_bubble_base` — базовая вероятность появления пузыря после сокращения.

> ⚠️ Значение `P_bubble_base` задаётся балансом и хранится в конфиге.

Формула:
```text
SpawnBubbleAfterCollapse = Random01() < P_bubble_base
```

Если `true` — создаём пузырь.

---

### 2.2 При сбросе фигуры (доп. триггер, Upgrade Bonus Level ≥ 4)
При прокачке бонусов уровня 4 добавляется шанс появления пузыря **при каждом сбросе фигуры**.

Вероятность фиксирована:
- `P_bubble_drop = 0.05` (5%)

Формула:
```text
SpawnBubbleOnDrop = Random01() < 0.05
```

Если `true` — создаём пузырь.

---

## 3. Где появляется пузырь (Spawn Position)

### 3.1 X позиция
Пузырь появляется в случайной позиции по X внутри стакана.

Обозначим:
- `CupInnerLeftX` — левая внутренняя граница стакана
- `CupInnerRightX` — правая внутренняя граница стакана

Формула:
```text
BubbleX = RandomRange(CupInnerLeftX, CupInnerRightX)
```

---

### 3.2 Y позиция
По Y пузырь появляется:
- либо на уровне **низа стакана**,
- либо слегка выше видимой области, чтобы он «выплывал».

Обозначим:
- `CupBottomY` — Y координата дна
- `OffscreenOffset` — смещение вниз (настройка)

Формула:
```text
BubbleY = CupBottomY
или
BubbleY = CupBottomY - OffscreenOffset
```

---

## 4. Поведение пузыря (Movement)

После спавна пузырь:
- плавно движется вверх
- движется волнообразно по X
- исчезает при выходе за верх экрана (без награды)

Обозначим:
- `t` — время с момента спавна
- `Vy` — вертикальная скорость
- `Ax` — амплитуда волны
- `Fx` — частота волны

Рекомендуемая модель движения:
```text
BubblePosY(t) = BubbleStartY + Vy * t
BubblePosX(t) = BubbleStartX + Ax * sin(Fx * t)
```

Параметры `Vy`, `Ax`, `Fx` задаются балансом.

---

## 5. Событие лопанья (Pop)

### 5.1 Лопнули пузырь
Если игрок нажал на пузырь:
- пузырь исчезает
- проигрывается VFX/SFX
- выдаётся награда (Reward), определённая при спавне

### 5.2 Пузырь улетел вверх
Если пузырь пересёк верхнюю границу экрана:
- пузырь уничтожается
- награда **не выдаётся**

---

## 6. Наполнение пузыря (Reward Selection)

После решения «пузырь появится» система выбирает тип награды.

### 6.1 Типы наград и вероятности

- **Монеты** — 40%
- **Дополнительные очки** — 45%
- **Мгновенные бонусы** — 12%
- **Расходуемые бонусы** — `0.1% * Level` *(обычно 1 раз за сессию из-за очень низкой вероятности)*

> Примечание: в игровом дизайне отдельно оговаривалось, что расходуемый бонус обычно выпадает **примерно 1 раз за сессию**.

---

### 6.2 Алгоритм распределения (рекомендуемый)

Чтобы корректно совместить фиксированные проценты (40/45/12) и редкую величину `0.1% * Level`, рекомендуется двухэтапная схема:

#### Этап A — Проверка на Consumable Reward
Сначала проверяем расходуемый бонус, т.к. у него отдельная вероятность.

Обозначим:
- `P_consumable = 0.001 * Level`  *(0.1% = 0.001)*

Формула:
```text
if Random01() < P_consumable:
    RewardType = Consumable
else:
    RewardType = WeightedPick(Coins=0.40, Points=0.45, Instant=0.12)
```

> Если включено ограничение “1 consumable за сессию”, то при получении первого consumable дальнейшие проверки на consumable игнорируются (до следующей сессии).

---

#### Этап B — Выбор среди Coins / Points / Instant
Если consumable не выпал, выбираем награду по фиксированным весам:

```text
RewardType = WeightedPick(
  Coins  = 0.40,
  Points = 0.45,
  Instant= 0.12
)
```

*(Если нужно строго нормализовать вероятности, можно делить на сумму весов. Важно, что соотношение сохраняется.)*

---

### 6.3 Детализация Instant Reward
Если `RewardType = Instant`:

- **Hail of Shapes** — 70%
- **Color Grenade** — 30%

Формула:
```text
InstantType = WeightedPick(
  Hail   = 0.70,
  Grenade= 0.30
)
```

---

### 6.4 Детализация Consumable Reward
Если `RewardType = Consumable`:

- **Touch-to-Kill** — 50%
- **Machine Gun** — 50%

Формула:
```text
ConsumableType = WeightedPick(
  TouchToKill = 0.50,
  MachineGun  = 0.50
)
```

---

## 7. Формулы наград (Amounts)

### 7.1 Монеты (Coins)
Количество монет из пузыря:

Обозначим:
- `r = RandomInt(1..5)`

Формула:
```text
MR = r * Level * Multiply * MoneyCoef
```

---

### 7.2 Очки (Points)
Количество очков из пузыря:

Обозначим:
- `r = RandomInt(1..5)`

Формула:
```text
PR = r * base * Level * Multiply * PointCoef
```

---

## 8. Правила влияния прокачки на пузыри

### 8.1 Bonus Drop Chance (отдельная прокачка)
Прокачка «вероятность выпадения бонуса» влияет на вероятность появления **пузыря с бонусом**. Рекомендуется применять её как множитель/модификатор к соответствующим весам (Coins/Points/Instant/Consumable) или к `P_bubble_base` — конкретный способ фиксируется балансом.

### 8.2 Bonus Upgrade Levels
Прокачка бонусов влияет на:
- увеличение частоты instant бонусов
- увеличение веса гранаты
- появление пузыря при drop (Level 4)
- уменьшение кулдауна расходуемых
- гарантирование instant в drop-пузырях (Level 6)
- повышение частоты consumable (Level 7)

---

## 9. Edge Cases

- Пузырь не должен спавниться в стенке (если BubbleX попал слишком близко к коллайдеру, clamp).
- Если пузырей на экране слишком много (например, > N), новые можно игнорировать (балансное ограничение).
- При GameOver все активные пузыри уничтожаются.

---

## 10. Implementation Notes

- Reward определяется **при спавне**, а не при клике (чтобы поведение было детерминированным).
- Визуальная часть (VFX/SFX) должна быть отделена от логики наград.
- Для тестов желательно иметь DebugOverlay, показывающий:
  - шанс спавна
  - выбранный тип награды
  - рассчитанное значение PR/MR

---

## 11. Мини-спецификация API (для кода)

Рекомендуемые структуры:

```text
BubbleSpawnContext:
- source: Collapse | Drop
- level: int
- multiply: float
- pointCoef: float
- moneyCoef: float

BubbleReward:
- type: Coins | Points | Instant | Consumable
- subtype: (для Instant/Consumable)
- amount: int (для Coins/Points)
```

Рекомендуемые функции:

```text
bool ShouldSpawnBubble(source)
Vector2 ComputeBubbleSpawnPosition()
BubbleReward RollBubbleReward(context)
int ComputeCoinReward(context)
int ComputePointReward(context)
```

---

**Конец документа.**
